## automake - create Makefile.in from Makefile.am
## Copyright 2004 Council for the Central Laboratories of the Research Councils

## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2, or (at your option)
## any later version.

## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.

## You should have received a copy of the GNU General Public License
## along with this program; if not, write to the Free Software
## Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
## 02111-1307, USA.


## This file contains material ADDITIONAL to FSF automake, for
## supporting the Starlink build system.

## The install-manifest has to work indirectly via an
## install-manifest-am target, because the way that
## $(RECURSIVE_TARGETS) works is that it calls $target for each of the
## subdirectories, but $target-am when the `subdirectory' is '.', so
## install-manifest-am must therefore exist, even if it doesn't do
## anything.  In the absence of SUBDIRS, this turns into
## `install-manifest: install-manifest-am'.  See install.am for an example.

.PHONY: install-manifest install-manifest-am

if %?SUBDIRS%
RECURSIVE_TARGETS += install-manifest-recursive
install-manifest: install-manifest-recursive
else !%?SUBDIRS%
install-manifest: install-manifest-am
endif !%?SUBDIRS%

if %?INSTALLMANIFEST%
# Create an install manifest, and install it in the required manifest location
if %?STANDARDMANIFEST%
install-manifest.xml: all-am
	rm -f $@
	echo "<?xml version='1.0'?>"                            >$@
	echo "<!DOCTYPE manifest SYSTEM 'componentinfo.dtd'>"   >>$@
	echo "<manifest component='$(PACKAGE)'>"                >>$@
	echo "<version>$(PACKAGE_VERSION)</version>"            >>$@
	echo "<files>"                                          >>$@
	env MANIFEST_FILE=`pwd`/$@ $(MAKE) install
	echo "</files>"                                         >>$@
	echo "</manifest>"                                      >>$@
else !%?STANDARDMANIFEST%
install-manifest.xml: all-am
	STG=$${TMPDIR-/tmp}/starconf-$$$$ ; \
	  rm -Rf $$STG ; \
	  mkdir $$STG ; \
	  ( %MANIFESTMAKEINSTALL% ) ; \
	  rm -f $@ ; \
	  echo "<?xml version='1.0'?>"                          >$@ ; \
	  echo "<!DOCTYPE manifest SYSTEM 'componentinfo.dtd'>" >>$@ ; \
	  echo "<manifest component='$(PACKAGE_NAME)'>"         >>$@ ; \
	  echo "<version>$(PACKAGE_VERSION)</version>"          >>$@ ; \
	  echo "<files>"                                        >>$@ ; \
	  find $$STG -type f -o -type l | sed "s,^$$STG,$(prefix)," >>$@ ; \
	  echo "</files>"                                       >>$@ ; \
	  echo "</manifest>"                                    >>$@ ; \
	  $(mkdir_p) $(DESTDIR)$(prefix) ; \
	  (cd $$STG; tar cf - .) | (cd $(DESTDIR)$(prefix) && tar xBpf -) ; \
	  echo rm -Rf $$STG
endif !%?STANDARDMANIFEST%


# Install the install-manifest.xml into the $(STAR_MANIFEST_DIR) directory.
# We should respect $(DESTDIR), but needn't worry about $(srcdir),
# since we know that the file was created in the current directory.
# Having done that, delete the install-manifest.xml file
install-manifest-am: install-manifest.xml
	@$(NORMAL_INSTALL)
	$(mkdir_p) $(DESTDIR)$(STAR_MANIFEST_DIR)
	$(INSTALL_DATA) install-manifest.xml \
		$(DESTDIR)$(STAR_MANIFEST_DIR)/$(PACKAGE)
	rm -f install-manifest.xml
else !%?INSTALLMANIFEST%
install-manifest-am: # nothing to do
endif !%?INSTALLMANIFEST%

if %?LATEXDOCS%
# Templates to generate documentation
.tex.dvi:
	latex $<; latex $<
.dvi.ps:
	dvips -o $@ $<
# Don't express a dependency via the directory .htx, or else Make
# tries to delete it as an intermediate.  An alternative is to use
# .PRECIOUS, but that's not completely straightforward to arrange.
# Requires that the STAR2HTML substitution was made in
# configure.ac, probably implicitly by the STAR_LATEX_DOCUMENTATION macro.
#
# We do not require that star2html be available on the build system,
# and so we distribute built HTX documentation.  Thus the following rules
# should be active only in the predist state.
@PREDIST@.tex.htx_tar:
@PREDIST@	- @STAR2HTML@ $<
@PREDIST@	tar cf $@ ${<:.tex=.htx}
endif %?LATEXDOCS%

if %?COMPIFL%
# Compile IFL files.  Requires that the COMPIFL substitution was made in
# configure.ac, probably implicitly by the STAR_MONOLITHS macro.
.ifl.ifc:
	@COMPIFL@ $<
endif %?COMPIFL%
